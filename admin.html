<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Administrativo - IBFAV</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js"></script>
</head>

<body class="admin">
  <div class="container">
    <div class="header">
      <h1>Painel Administrativo</h1>
    </div>

    <!-- LOGIN -->
    <div class="auth-section" id="login-section">
      <h2>Login de Administrador</h2>
      <div class="form-group">
        <label>Email:</label>
        <input type="email" id="loginEmail" placeholder="Digite seu email">
      </div>
      <div class="form-group">
        <label>Senha:</label>
        <input type="password" id="loginPassword" placeholder="Digite sua senha">
      </div>
      <button class="btn btn-primary" id="loginBtn">Entrar</button>
      <div id="loginMessage"></div>
      <button class="logout-btn" onclick="voltarPagina()">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>

    <!-- PAINEL ADMIN -->
    <div class="admin-panel" id="admin-panel" style="display:none;">
      <button class="logout-btn" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>

      <div class="tabs">
        <button class="tab-btn active" data-tab="photos-tab">
          <i class="fas fa-images"></i> Gerenciar Fotos
        </button>
        <button class="tab-btn" data-tab="events-tab">
          <i class="fas fa-calendar-alt"></i> Gerenciar Agenda
        </button>
        <button class="tab-btn" data-tab="usuarios">
          <i class="fas fa-user"></i> Gerenciar Usu√°rios
        </button>
        <button class="tab-btn" data-tab="info">
          <i class="fas fa-info-circle"></i> Informa√ß√µes
        </button>
      </div>

      <!-- Aba de Fotos -->
      <div class="tab-content active" id="photos-tab">
        <h3><i class="fas fa-camera"></i> Upload de Fotos</h3>

        <form id="photo-form">
          <div class="form-group">
            <label>Selecionar Fotos:</label>
            <div class="file-upload">
              <input type="file" id="photo-files" multiple accept="image/*">
              <label for="photo-files" class="file-upload-label">
                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>
                Clique para selecionar fotos
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="photo-description">Descri√ß√£o:</label>
            <textarea id="photo-description" rows="3" placeholder="Descri√ß√£o das fotos (opcional)"></textarea>
          </div>

          <button type="submit" class="btn btn-success">
            <i class="fas fa-upload"></i> Enviar Fotos
          </button>
        </form>

        <div class="loading" id="photo-loading">
          <div class="spinner"></div>
          <p>Enviando fotos...</p>
        </div>

        <h3 style="margin-top: 40px;"><i class="fas fa-photo-video"></i> Fotos Publicadas</h3>
        <div class="items-grid" id="photos-grid"></div>
      </div>

      <!-- Aba de Eventos -->
      <div class="tab-content" id="events-tab">
        <h3><i class="fas fa-plus-circle"></i> Adicionar Evento</h3>

        <form id="event-form">
          <div class="form-group">
            <label for="event-title">T√≠tulo do Evento:</label>
            <input type="text" id="event-title" required placeholder="Ex: Culto de Ensino">
          </div>

          <div class="form-group">
            <label for="event-date">Data:</label>
            <input type="date" id="event-date" required>
          </div>

          <div class="form-group">
            <label for="event-time">Hor√°rio:</label>
            <input type="time" id="event-time" required>
          </div>

          <div class="form-group">
            <label for="event-description">Descri√ß√£o:</label>
            <textarea id="event-description" rows="4" placeholder="Descri√ß√£o do evento"></textarea>
          </div>

          <div class="form-group">
            <label for="event-location">Local:</label>
            <input type="text" id="event-location" placeholder="Local do evento">
          </div>

          <button type="submit" class="btn btn-success">
            <i class="fas fa-calendar-plus"></i> Adicionar Evento
          </button>
        </form>

        <div class="loading" id="event-loading">
          <div class="spinner"></div>
          <p>Salvando evento...</p>
        </div>

        <h3 style="margin-top: 40px;"><i class="fas fa-list"></i> Eventos Cadastrados</h3>
        <div class="items-grid" id="events-grid"></div>
      </div>

      <!-- ABA USU√ÅRIOS -->
      <div class="tab-content" id="usuarios">
        <h2>Gerenciar Usu√°rios</h2>

        <div class="form-group">
          <label>Email do novo usu√°rio:</label>
          <input type="email" id="newUserEmail" placeholder="exemplo@email.com">
        </div>

        <div class="form-group">
          <label>Senha:</label>
          <input type="password" id="newUserPassword" placeholder="m√≠nimo 6 caracteres">
        </div>

        <div class="form-group">
          <label>Fun√ß√£o (role):</label>
          <select id="newUserRole">
            <option value="usuario">Usu√°rio</option>
            <option value="editor">Editor</option>
            <option value="admin">Administrador</option>
          </select>
        </div>

        <button class="btn btn-success" id="createUserBtn">Criar Usu√°rio</button>
        <div id="userMessage"></div>

        <h3>Lista de Usu√°rios</h3>
        <div class="items-grid" id="usersList"></div>
      </div>

      <!-- ABA INFORMA√á√ïES -->
      <div class="tab-content" id="info">
        <h2>Informa√ß√µes do Sistema</h2>
        <div class="info-cards">
          <div class="info-card">
            <i class="fas fa-calendar-alt"></i>
            <h3 id="totalEvents">0</h3>
            <p>Total de Eventos</p>
          </div>
          <div class="info-card">
            <i class="fas fa-images"></i>
            <h3 id="totalPhotos">0</h3>
            <p>Total de Fotos</p>
          </div>
          <div class="info-card">
            <i class="fas fa-users"></i>
            <h3 id="totalUsers">0</h3>
            <p>Total de Usu√°rios</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('üîß Iniciando painel administrativo...');

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC0CY0Ds3tARkQFSOAOY8aVMnoFvDbu9Rs",
      authDomain: "ibfav-c9d00.firebaseapp.com",
      projectId: "ibfav-c9d00",
      storageBucket: "ibfav-c9d00.firebasestorage.app",
      // storageBucket: "ibfav-c9d00.appspot.com",
      messagingSenderId: "666092929823",
      appId: "1:666092929823:web:c17194e606d41da397662a"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    console.log('‚úÖ Firebase inicializado');

    // LOGIN
    const loginBtn = document.getElementById("loginBtn");
    const loginMessage = document.getElementById("loginMessage");

    loginBtn.addEventListener("click", handleLogin);
    
    document.getElementById("loginPassword").addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    async function handleLogin() {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      
      if (!email || !password) {
        loginMessage.innerHTML = "<p class='error-message'>Preencha todos os campos.</p>";
        return;
      }

      try {
        loginMessage.innerHTML = "<p>Verificando credenciais...</p>";
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        const doc = await db.collection("users").doc(user.uid).get();

        if (!doc.exists || doc.data().role !== "admin") {
          loginMessage.innerHTML = "<p class='error-message'>Acesso negado. Somente administradores podem entrar.</p>";
          await auth.signOut();
          return;
        }

        loginMessage.innerHTML = "";
        document.getElementById("login-section").style.display = "none";
        document.getElementById("admin-panel").style.display = "block";
        
        // Carregar dados
        loadUsers();
        loadPhotos();
        loadEvents();
        loadStats();
        
      } catch (error) {
        console.error('Erro no login:', error);
        loginMessage.innerHTML = `<p class='error-message'>Erro: ${error.message}</p>`;
      }
    }

    // LOGOUT
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await auth.signOut();
      document.getElementById("admin-panel").style.display = "none";
      document.getElementById("login-section").style.display = "block";
      document.getElementById("loginPassword").value = '';
      document.getElementById("loginEmail").value = '';
    });

    // Voltar √† p√°gina inicial
    function voltarPagina() {
      window.location.href = '/index.html';
    }

    // TROCA DE ABAS
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    // CRIAR NOVO USU√ÅRIO
    document.getElementById("createUserBtn").addEventListener("click", async () => {
      const email = document.getElementById("newUserEmail").value.trim();
      const password = document.getElementById("newUserPassword").value.trim();
      const role = document.getElementById("newUserRole").value;
      const userMessage = document.getElementById("userMessage");

      if (!email || !password) {
        userMessage.innerHTML = "<p class='error-message'>Preencha todos os campos.</p>";
        return;
      }

      if (password.length < 6) {
        userMessage.innerHTML = "<p class='error-message'>A senha deve ter no m√≠nimo 6 caracteres.</p>";
        return;
      }

      try {
        userMessage.innerHTML = "<p>Criando usu√°rio...</p>";
        
        // Criar usu√°rio via Firebase Auth REST API
        const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, returnSecureToken: true })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }

        // Salvar fun√ß√£o (role) no Firestore
        await db.collection("users").doc(data.localId).set({
          email: email,
          role: role,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        userMessage.innerHTML = "<p class='success-message'>Usu√°rio criado com sucesso!</p>";
        document.getElementById("newUserEmail").value = '';
        document.getElementById("newUserPassword").value = '';
        loadUsers();
        loadStats();
        
      } catch (error) {
        console.error('Erro ao criar usu√°rio:', error);
        userMessage.innerHTML = `<p class='error-message'>Erro: ${error.message}</p>`;
      }
    });

    // LISTAR USU√ÅRIOS
    async function loadUsers() {
      const list = document.getElementById("usersList");
      list.innerHTML = "<p>Carregando...</p>";

      try {
        const snapshot = await db.collection("users").get();
        list.innerHTML = "";
        
        if (snapshot.empty) {
          list.innerHTML = "<p>Nenhum usu√°rio encontrado.</p>";
          return;
        }
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement('div');
          card.className = 'item-card';
          card.innerHTML = `
            <h4><i class="fas fa-user"></i> ${data.email}</h4>
            <p><strong>Fun√ß√£o:</strong> ${data.role}</p>
            <p><strong>Criado em:</strong> ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</p>
          `;
          list.appendChild(card);
        });
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        list.innerHTML = "<p class='error-message'>Erro ao carregar usu√°rios.</p>";
      }
    }

    // UPLOAD DE FOTOS
    document.getElementById('photo-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const files = document.getElementById('photo-files').files;
      const description = document.getElementById('photo-description').value;

      if (files.length === 0) {
        showMessage('Selecione pelo menos uma foto!', 'error');
        return;
      }

      const loading = document.getElementById('photo-loading');
      loading.style.display = 'block';

      try {
        let uploadedCount = 0;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Validar tipo de arquivo
          if (!file.type.startsWith('image/')) {
            console.warn(`Arquivo ${file.name} n√£o √© uma imagem v√°lida`);
            continue;
          }
          
          const timestamp = Date.now();
          const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
          const fileName = `photos/${timestamp}_${i}_${sanitizedName}`;

          console.log(`üì§ Enviando foto ${i + 1}/${files.length}: ${file.name}`);

          // Upload para Storage
          const storageRef = storage.ref(fileName);
          const uploadTask = await storageRef.put(file);
          
          console.log('‚úÖ Upload conclu√≠do, obtendo URL...');
          const downloadURL = await uploadTask.ref.getDownloadURL();
          
          console.log('‚úÖ URL obtida:', downloadURL);

          // Salvar no Firestore
          await db.collection('photos').add({
            url: downloadURL,
            description: description || 'Sem descri√ß√£o',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            fileName: fileName
          });
          
          uploadedCount++;
          console.log(`‚úÖ Foto ${uploadedCount} salva no Firestore`);
        }

        if (uploadedCount > 0) {
          showMessage(`${uploadedCount} foto(s) enviada(s) com sucesso!`, 'success');
          document.getElementById('photo-form').reset();
          document.querySelector('.file-upload-label').innerHTML = '<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>Clique para selecionar fotos';
          loadPhotos();
          loadStats();
        } else {
          showMessage('Nenhuma foto v√°lida foi enviada.', 'error');
        }

      } catch (error) {
        console.error('‚ùå Erro ao enviar fotos:', error);
        showMessage(`Erro ao enviar fotos: ${error.message}`, 'error');
      } finally {
        loading.style.display = 'none';
      }
    });

    // CARREGAR FOTOS
    async function loadPhotos() {
      const grid = document.getElementById('photos-grid');
      grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando fotos...</p></div>';

      try {
        const snapshot = await db.collection('photos').orderBy('timestamp', 'desc').get();
        grid.innerHTML = '';

        if (snapshot.empty) {
          grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma foto encontrada.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const photoCard = createPhotoCard(doc.id, data);
          grid.appendChild(photoCard);
        });

      } catch (error) {
        console.error('Erro ao carregar fotos:', error);
        grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar fotos.</p>';
      }
    }

    // CRIAR CARD DE FOTO
    function createPhotoCard(id, data) {
      const card = document.createElement('div');
      card.className = 'item-card';
      card.innerHTML = `
        <img src="${data.url}" alt="Foto da igreja" class="item-image">
        <p><strong>Descri√ß√£o:</strong> ${data.description || 'Sem descri√ß√£o'}</p>
        <p><strong>Data:</strong> ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</p>
        <div class="item-actions">
          <button class="btn btn-danger" onclick="deletePhoto('${id}', '${data.fileName}')">
            <i class="fas fa-trash"></i> Excluir
          </button>
        </div>
      `;
      return card;
    }

    // EXCLUIR FOTO (Global)
    window.deletePhoto = async function(docId, fileName) {
      if (!confirm('Tem certeza que deseja excluir esta foto?')) return;

      try {
        // Deletar do Storage
        if (fileName) {
          await storage.ref().child(fileName).delete();
        }

        // Deletar do Firestore
        await db.collection('photos').doc(docId).delete();

        showMessage('Foto exclu√≠da com sucesso!', 'success');
        loadPhotos();
        loadStats();

      } catch (error) {
        console.error('Erro ao excluir foto:', error);
        showMessage('Erro ao excluir foto.', 'error');
      }
    }

    // ADICIONAR EVENTO
    document.getElementById('event-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('event-title').value;
      const date = document.getElementById('event-date').value;
      const time = document.getElementById('event-time').value;
      const description = document.getElementById('event-description').value;
      const location = document.getElementById('event-location').value;

      const loading = document.getElementById('event-loading');
      loading.classList.add('show');

      try {
        await db.collection('events').add({
          title: title,
          date: date,
          time: time,
          description: description,
          location: location,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMessage('Evento adicionado com sucesso!', 'success');
        document.getElementById('event-form').reset();
        loadEvents();
        loadStats();

      } catch (error) {
        console.error('Erro ao adicionar evento:', error);
        showMessage('Erro ao adicionar evento.', 'error');
      } finally {
        loading.classList.remove('show');
      }
    });

    // CARREGAR EVENTOS
    async function loadEvents() {
      const grid = document.getElementById('events-grid');
      grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando eventos...</p></div>';

      try {
        const snapshot = await db.collection('events').orderBy('date', 'asc').get();
        grid.innerHTML = '';

        if (snapshot.empty) {
          grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhum evento encontrado.</p>';
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const eventCard = createEventCard(doc.id, data);
          grid.appendChild(eventCard);
        });

      } catch (error) {
        console.error('Erro ao carregar eventos:', error);
        grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar eventos.</p>';
      }
    }

    // CRIAR CARD DE EVENTO
    function createEventCard(id, data) {
      const card = document.createElement('div');
      card.className = 'item-card';
      const eventDate = new Date(data.date + 'T' + data.time);
      const isUpcoming = eventDate > new Date();

      card.innerHTML = `
        <div style="border-left: 4px solid ${isUpcoming ? '#00b894' : '#ddd'}; padding-left: 15px;">
          <h4 style="color: ${isUpcoming ? '#00b894' : '#666'};">${data.title}</h4>
          <p><i class="fas fa-calendar"></i> ${new Date(data.date).toLocaleDateString('pt-BR')}</p>
          <p><i class="fas fa-clock"></i> ${data.time}</p>
          ${data.location ? `<p><i class="fas fa-map-marker-alt"></i> ${data.location}</p>` : ''}
          ${data.description ? `<p><i class="fas fa-info-circle"></i> ${data.description}</p>` : ''}
          <small style="color: #999;">Status: ${isUpcoming ? 'üü¢ Pr√≥ximo' : 'üî¥ Passado'}</small>
        </div>
        <div class="item-actions">
          <button class="btn btn-danger" onclick="deleteEvent('${id}')">
            <i class="fas fa-trash"></i> Excluir
          </button>
        </div>
      `;
      return card;
    }

    // EXCLUIR EVENTO (Global)
    window.deleteEvent = async function(docId) {
      if (!confirm('Tem certeza que deseja excluir este evento?')) return;

      try {
        await db.collection('events').doc(docId).delete();
        showMessage('Evento exclu√≠do com sucesso!', 'success');
        loadEvents();
        loadStats();

      } catch (error) {
        console.error('Erro ao excluir evento:', error);
        showMessage('Erro ao excluir evento.', 'error');
      }
    }

    // CARREGAR ESTAT√çSTICAS
    async function loadStats() {
      try {
        const eventsSnapshot = await db.collection('events').get();
        const photosSnapshot = await db.collection('photos').get();
        const usersSnapshot = await db.collection('users').get();

        document.getElementById('totalEvents').textContent = eventsSnapshot.size;
        document.getElementById('totalPhotos').textContent = photosSnapshot.size;
        document.getElementById('totalUsers').textContent = usersSnapshot.size;
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
      }
    }

    // MOSTRAR MENSAGENS
    function showMessage(message, type) {
      // Remove mensagens existentes
      document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());

      const messageDiv = document.createElement('div');
      messageDiv.className = type + '-message';
      messageDiv.textContent = message;

      const activeTab = document.querySelector('.tab-content.active');
      activeTab.insertBefore(messageDiv, activeTab.firstChild);

      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // PREVIEW DE ARQUIVOS SELECIONADOS
    document.getElementById('photo-files').addEventListener('change', function (e) {
      const files = e.target.files;
      const label = document.querySelector('.file-upload-label');

      if (files.length > 0) {
        label.innerHTML = `<i class="fas fa-check-circle" style="color: #00b894; font-size: 2rem; margin-right: 10px;"></i>${files.length} foto(s) selecionada(s)`;
      } else {
        label.innerHTML = '<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>Clique para selecionar fotos';
      }
    });

    console.log('‚úÖ Painel administrativo carregado');
  </script>
</body>

</html>