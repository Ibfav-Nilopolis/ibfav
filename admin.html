<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - IBFAV</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Verificar se scripts estão na ordem correta -->
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js"></script>
</head>

<body class="admin">
    <div class="container">
        <div class="header">
            <h1> Painel Administrativo IBFAV</h1>
            <p>Gerencie fotos e eventos da igreja</p>
        </div>

        <!-- Seção de Autenticação -->
        <div class="auth-section" id="auth-section">
            <h2><i class="fas fa-lock"></i> Acesso Administrativo</h2>
            <div class="form-group">
                <label for="admin-password">Senha de Administrador:</label>
                <input type="password" id="admin-password" placeholder="Digite a senha">
            </div>
            <button class="btn btn-primary" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div id="login-error" class="error-message" style="display: none;">
                Senha incorreta. Tente novamente.
            </div>
            <button class="logout-btn" onclick="voltarPagina()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>

        <!-- Painel Administrativo -->
        <div class="admin-panel" id="admin-panel">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('photos')">
                    <i class="fas fa-images"></i> Gerenciar Fotos
                </button>
                <button class="tab-btn" onclick="switchTab('events')">
                    <i class="fas fa-calendar-alt"></i> Gerenciar Agenda
                </button>
            </div>

            <!-- Aba de Fotos -->
            <div class="tab-content active" id="photos-tab">
                <h3><i class="fas fa-camera"></i> Upload de Fotos</h3>

                <form id="photo-form">
                    <div class="form-group">
                        <label>Selecionar Fotos:</label>
                        <div class="file-upload">
                            <input type="file" id="photo-files" multiple accept="image/*">
                            <label for="photo-files" class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>
                                Clique para selecionar fotos
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="photo-description">Descrição:</label>
                        <textarea id="photo-description" rows="3"
                            placeholder="Descrição das fotos (opcional)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Enviar Fotos
                    </button>
                </form>

                <div class="loading" id="photo-loading">
                    <div class="spinner"></div>
                    <p>Enviando fotos...</p>
                </div>

                <h3 style="margin-top: 40px;"><i class="fas fa-photo-video"></i> Fotos Publicadas</h3>
                <div class="items-grid" id="photos-grid"></div>
            </div>

            <!-- Aba de Eventos -->
            <div class="tab-content" id="events-tab">
                <h3><i class="fas fa-plus-circle"></i> Adicionar Evento</h3>

                <form id="event-form">
                    <div class="form-group">
                        <label for="event-title">Título do Evento:</label>
                        <input type="text" id="event-title" required placeholder="Ex: Culto de Ensino">
                    </div>

                    <div class="form-group">
                        <label for="event-date">Data:</label>
                        <input type="date" id="event-date" required>
                    </div>

                    <div class="form-group">
                        <label for="event-time">Horário:</label>
                        <input type="time" id="event-time" required>
                    </div>

                    <div class="form-group">
                        <label for="event-description">Descrição:</label>
                        <textarea id="event-description" rows="4" placeholder="Descrição do evento"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="event-location">Local:</label>
                        <input type="text" id="event-location" placeholder="Local do evento">
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-calendar-plus"></i> Adicionar Evento
                    </button>
                </form>

                <div class="loading" id="event-loading">
                    <div class="spinner"></div>
                    <p>Salvando evento...</p>
                </div>

                <h3 style="margin-top: 40px;"><i class="fas fa-list"></i> Eventos Cadastrados</h3>
                <div class="items-grid" id="events-grid"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    
    <script>
        // Configuração do Firebase (mesma do site principal)
        const firebaseConfig = {
            apiKey: "AIzaSyC0CY0Ds3tARkQFSOAOY8aVMnoFvDbu9Rs",
            authDomain: "ibfav-c9d00.firebaseapp.com",
            projectId: "ibfav-c9d00",
            storageBucket: "ibfav-c9d00.firebasestorage.app",
            // storageBucket: "ibfav-c9d00.appspot.com",
            messagingSenderId: "666092929823",
            appId: "1:666092929823:web:c17194e606d41da397662a"
        };

        // Inicializar Firebase

        let app, db, storage;

        try {
            // Inicializar Firebase
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
        }

        // const app = firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore();
        // const storage = firebase.storage();

        // Senha de administrador (em produção, use autenticação mais segura)
        const ADMIN_PASSWORD = 'ibfav2025admin';

        // Estado da aplicação
        // let isAuthenticated = false;

        // Funções de autenticação
        function login() {
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');

            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadPhotos();
                loadEvents();
                errorDiv.style.display = 'none';
            } else {
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }

        //Função de voltar home
        function voltarPagina() {
            history.back();
        }

        // Verificar autenticação na tecla Enter
        document.getElementById('admin-password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Funções de navegação
        function switchTab(tabName) {
            // Remover classe active de todos os botões e conteúdos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Adicionar classe active ao botão e conteúdo selecionados
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');

            // Carregar dados da aba ativa
            if (tabName === 'photos') {
                loadPhotos();
            } else if (tabName === 'events') {
                loadEvents();
            }
        }

        // Funções de upload de fotos
        document.getElementById('photo-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const files = document.getElementById('photo-files').files;
            const description = document.getElementById('photo-description').value;

            if (files.length === 0) {
                alert('Selecione pelo menos uma foto!');
                return;
            }

            const loading = document.getElementById('photo-loading');
            loading.classList.add('show');

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const timestamp = Date.now();
                    const fileName = `photos/${timestamp}_${i}_${file.name}`;

                    // Upload para Storage
                    const storageRef = storage.ref().child(fileName);
                    const uploadTask = await storageRef.put(file);
                    const downloadURL = await uploadTask.ref.getDownloadURL();

                    // Salvar no Firestore
                    await db.collection('photos').add({
                        url: downloadURL,
                        description: description,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        fileName: fileName
                    });
                }

                showMessage('Fotos enviadas com sucesso!', 'success');
                document.getElementById('photo-form').reset();
                loadPhotos();

            } catch (error) {
                console.error('Erro ao enviar fotos:', error);
                showMessage('Erro ao enviar fotos. Tente novamente.', 'error');
            } finally {
                loading.classList.remove('show');
            }
        });

        // Função para carregar fotos
        async function loadPhotos() {
            const grid = document.getElementById('photos-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando fotos...</p></div>';

            try {
                const snapshot = await db.collection('photos').orderBy('timestamp', 'desc').get();
                grid.innerHTML = '';

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma foto encontrada.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const photoCard = createPhotoCard(doc.id, data);
                    grid.appendChild(photoCard);
                });

            } catch (error) {
                console.error('Erro ao carregar fotos:', error);
                grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar fotos.</p>';
            }
        }

        // Criar card de foto
        function createPhotoCard(id, data) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <img src="${data.url}" alt="Foto da igreja" class="item-image">
                <p><strong>Descrição:</strong> ${data.description || 'Sem descrição'}</p>
                <p><strong>Data:</strong> ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</p>
                <div class="item-actions">
                    <button class="btn btn-danger" onclick="deletePhoto('${id}', '${data.fileName}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        // Excluir foto
        async function deletePhoto(docId, fileName) {
            if (!confirm('Tem certeza que deseja excluir esta foto?')) return;

            try {
                // Deletar do Storage
                if (fileName) {
                    await storage.ref().child(fileName).delete();
                }

                // Deletar do Firestore
                await db.collection('photos').doc(docId).delete();

                showMessage('Foto excluída com sucesso!', 'success');
                loadPhotos();

            } catch (error) {
                console.error('Erro ao excluir foto:', error);
                showMessage('Erro ao excluir foto.', 'error');
            }
        }

        // Funções de eventos
        document.getElementById('event-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const description = document.getElementById('event-description').value;
            const location = document.getElementById('event-location').value;

            const loading = document.getElementById('event-loading');
            loading.classList.add('show');

            try {
                await db.collection('events').add({
                    title: title,
                    date: date,
                    time: time,
                    description: description,
                    location: location,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('Evento adicionado com sucesso!', 'success');
                document.getElementById('event-form').reset();
                loadEvents();

            } catch (error) {
                console.error('Erro ao adicionar evento:', error);
                showMessage('Erro ao adicionar evento.', 'error');
            } finally {
                loading.classList.remove('show');
            }
        });

        // Carregar eventos
        async function loadEvents() {
            const grid = document.getElementById('events-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando eventos...</p></div>';

            try {
                const snapshot = await db.collection('events').orderBy('date', 'asc').get();
                grid.innerHTML = '';

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhum evento encontrado.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const eventCard = createEventCard(doc.id, data);
                    grid.appendChild(eventCard);
                });

            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar eventos.</p>';
            }
        }

        // Criar card de evento
        function createEventCard(id, data) {
            const card = document.createElement('div');
            card.className = 'item-card';
            const eventDate = new Date(data.date + 'T' + data.time);
            const isUpcoming = eventDate > new Date();

            card.innerHTML = `
                <div style="border-left: 4px solid ${isUpcoming ? '#00b894' : '#ddd'}; padding-left: 15px;">
                    <h4 style="color: ${isUpcoming ? '#00b894' : '#666'};">${data.title}</h4>
                    <p><i class="fas fa-calendar"></i> ${new Date(data.date).toLocaleDateString('pt-BR')}</p>
                    <p><i class="fas fa-clock"></i> ${data.time}</p>
                    ${data.location ? `<p><i class="fas fa-map-marker-alt"></i> ${data.location}</p>` : ''}
                    ${data.description ? `<p><i class="fas fa-info-circle"></i> ${data.description}</p>` : ''}
                    <small style="color: #999;">Status: ${isUpcoming ? '🟢 Próximo' : '🔴 Passado'}</small>
                </div>
                <div class="item-actions">
                    <button class="btn btn-danger" onclick="deleteEvent('${id}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        // Excluir evento
        async function deleteEvent(docId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;

            try {
                await db.collection('events').doc(docId).delete();
                showMessage('Evento excluído com sucesso!', 'success');
                loadEvents();

            } catch (error) {
                console.error('Erro ao excluir evento:', error);
                showMessage('Erro ao excluir evento.', 'error');
            }
        }

        // Mostrar mensagens
        function showMessage(message, type) {
            // Remove mensagens existentes
            document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = type + '-message';
            messageDiv.textContent = message;

            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Preview de arquivos selecionados
        document.getElementById('photo-files').addEventListener('change', function (e) {
            const files = e.target.files;
            const label = document.querySelector('.file-upload-label');

            if (files.length > 0) {
                label.innerHTML = `<i class="fas fa-check-circle" style="color: #00b894; font-size: 2rem; margin-right: 10px;"></i>${files.length} foto(s) selecionada(s)`;
            } else {
                label.innerHTML = '<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>Clique para selecionar fotos';
            }
        });
    </script>
</body>

</html>