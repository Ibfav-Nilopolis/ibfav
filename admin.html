<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - IBFAV</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- ‚úÖ SCRIPTS FIREBASE CORRETOS (VERS√ÉO COMPAT) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
</head>

<body class="admin">
    <div class="container">
        <div class="header">
            <h1> Painel Administrativo IBFAV</h1>
            <p>Gerencie fotos e eventos da igreja</p>
        </div>

        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div class="auth-section" id="auth-section">
            <h2><i class="fas fa-lock"></i> Acesso Administrativo</h2>
            <div class="form-group">
                <label for="admin-password">Senha de Administrador:</label>
                <input type="password" id="admin-password" placeholder="Digite a senha">
                <!-- <small style="display: block; margin-top: 5px; color: #666;">Senha: ibfav2025admin</small> -->
            </div>
            <button class="btn btn-primary" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div id="login-error" class="error-message" style="display: none;">
                Senha incorreta. Tente novamente.
            </div>
            <button class="btn btn-secondary" onclick="voltarPagina()" style="margin-top: 15px;">
                <i class="fas fa-arrow-left"></i> Voltar ao Site
            </button>
        </div>

        <!-- Painel Administrativo -->
        <div class="admin-panel" id="admin-panel" style="display: none;">
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'photos')">
                    <i class="fas fa-images"></i> Gerenciar Fotos
                </button>
                <button class="tab-btn" onclick="switchTab(event, 'events')">
                    <i class="fas fa-calendar-alt"></i> Gerenciar Agenda
                </button>
            </div>

            <!-- Aba de Fotos -->
            <div class="tab-content active" id="photos-tab">
                <h3><i class="fas fa-camera"></i> Upload de Fotos</h3>

                <form id="photo-form">
                    <div class="form-group">
                        <label>Selecionar Fotos:</label>
                        <div class="file-upload">
                            <input type="file" id="photo-files" multiple accept="image/*">
                            <label for="photo-files" class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>
                                Clique para selecionar fotos
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="photo-description">Descri√ß√£o:</label>
                        <textarea id="photo-description" rows="3"
                            placeholder="Descri√ß√£o das fotos (opcional)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Enviar Fotos
                    </button>
                </form>

                <div class="loading" id="photo-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Enviando fotos...</p>
                </div>

                <h3 style="margin-top: 40px;"><i class="fas fa-photo-video"></i> Fotos Publicadas</h3>
                <div class="items-grid" id="photos-grid">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>

            <!-- Aba de Eventos -->
            <div class="tab-content" id="events-tab">
                <h3><i class="fas fa-plus-circle"></i> Adicionar Evento</h3>

                <form id="event-form">
                    <div class="form-group">
                        <label for="event-title">T√≠tulo do Evento:</label>
                        <input type="text" id="event-title" required placeholder="Ex: Culto de Ensino">
                    </div>

                    <div class="form-group">
                        <label for="event-date">Data:</label>
                        <input type="date" id="event-date" required>
                    </div>

                    <div class="form-group">
                        <label for="event-time">Hor√°rio:</label>
                        <input type="time" id="event-time" required>
                    </div>

                    <div class="form-group">
                        <label for="event-description">Descri√ß√£o:</label>
                        <textarea id="event-description" rows="4" placeholder="Descri√ß√£o do evento"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="event-location">Local:</label>
                        <input type="text" id="event-location" placeholder="Local do evento" 
                            value="Tv. Natividade, 07 - Novo Horizonte, Nil√≥polis - RJ">
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-calendar-plus"></i> Adicionar Evento
                    </button>
                </form>

                <div class="loading" id="event-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Salvando evento...</p>
                </div>

                <h3 style="margin-top: 40px;"><i class="fas fa-list"></i> Eventos Cadastrados</h3>
                <div class="items-grid" id="events-grid">
                    <p style="text-align: center; color: #666;">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üî• Iniciando painel administrativo...');

        // Verificar se Firebase foi carregado
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase n√£o carregado!');
            alert('ERRO: Firebase n√£o foi carregado. Verifique sua conex√£o com a internet.');
        } else {
            console.log('‚úÖ Firebase carregado com sucesso');
        }

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC0CY0Ds3tARkQFSOAOY8aVMnoFvDbu9Rs",
            authDomain: "ibfav-c9d00.firebaseapp.com",
            projectId: "ibfav-c9d00",
            storageBucket: "ibfav-c9d00.appspot.com",
            messagingSenderId: "666092929823",
            appId: "1:666092929823:web:c17194e606d41da397662a"
        };

        let app, db, storage;

        try {
            // Inicializar Firebase
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('‚úÖ Firebase inicializado:', app.name);
            console.log('‚úÖ Firestore conectado');
            console.log('‚úÖ Storage conectado');
        } catch (error) {
            console.error('‚ùå Erro ao inicializar Firebase:', error);
            alert('Erro ao inicializar Firebase: ' + error.message);
        }

        // Senha de administrador
        const ADMIN_PASSWORD = 'ibfav2025admin';
        console.log('‚úÖ Senha configurada');

        // Estado da aplica√ß√£o
        let isAuthenticated = false;

        // Fun√ß√µes de autentica√ß√£o
        function login() {
            console.log('üîê Tentando fazer login...');
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');

            console.log('Senha digitada:', password.length, 'caracteres');

            if (password === ADMIN_PASSWORD) {
                console.log('‚úÖ Login bem-sucedido!');
                isAuthenticated = true;
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                errorDiv.style.display = 'none';
                
                // Carregar dados
                loadPhotos();
                loadEvents();
            } else {
                console.log('‚ùå Senha incorreta');
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            console.log('üö™ Fazendo logout...');
            isAuthenticated = false;
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }

        // Fun√ß√£o de voltar home
        function voltarPagina() {
            window.location.href = 'index.html';
        }

        // Verificar autentica√ß√£o na tecla Enter
        document.getElementById('admin-password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Fun√ß√µes de navega√ß√£o
        function switchTab(event, tabName) {
            console.log('üìë Mudando para aba:', tabName);
            
            // Remover classe active de todos os bot√µes e conte√∫dos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Adicionar classe active ao bot√£o e conte√∫do selecionados
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');

            // Carregar dados da aba ativa
            if (tabName === 'photos') {
                loadPhotos();
            } else if (tabName === 'events') {
                loadEvents();
            }
        }

        // Fun√ß√µes de upload de fotos
        document.getElementById('photo-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            console.log('üì§ Iniciando upload de fotos...');

            const files = document.getElementById('photo-files').files;
            const description = document.getElementById('photo-description').value;

            if (files.length === 0) {
                alert('Selecione pelo menos uma foto!');
                console.log('‚ùå Nenhuma foto selecionada');
                return;
            }

            console.log(`üì∏ ${files.length} foto(s) selecionada(s)`);

            const loading = document.getElementById('photo-loading');
            loading.style.display = 'block';

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const timestamp = Date.now();
                    const fileName = `photos/${timestamp}_${i}_${file.name}`;

                    console.log(`üì§ Enviando: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

                    // Upload para Storage
                    const storageRef = storage.ref().child(fileName);
                    const uploadTask = await storageRef.put(file);
                    const downloadURL = await uploadTask.ref.getDownloadURL();

                    console.log(`‚úÖ Upload conclu√≠do: ${file.name}`);
                    console.log(`üîó URL: ${downloadURL}`);

                    // Salvar no Firestore
                    await db.collection('photos').add({
                        url: downloadURL,
                        description: description,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        fileName: fileName
                    });

                    console.log(`üíæ Salvo no Firestore`);
                }

                showMessage('‚úÖ Fotos enviadas com sucesso!', 'success');
                document.getElementById('photo-form').reset();
                document.querySelector('.file-upload-label').innerHTML = 
                    '<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>Clique para selecionar fotos';
                loadPhotos();

            } catch (error) {
                console.error('‚ùå Erro ao enviar fotos:', error);
                showMessage('‚ùå Erro ao enviar fotos: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Fun√ß√£o para carregar fotos
        async function loadPhotos() {
            console.log('üì∏ Carregando fotos...');
            const grid = document.getElementById('photos-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando fotos...</p></div>';

            try {
                const snapshot = await db.collection('photos').orderBy('timestamp', 'desc').get();
                grid.innerHTML = '';

                console.log(`‚úÖ ${snapshot.docs.length} foto(s) encontrada(s)`);

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma foto encontrada. Fa√ßa upload de fotos acima.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const photoCard = createPhotoCard(doc.id, data);
                    grid.appendChild(photoCard);
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar fotos:', error);
                grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar fotos: ' + error.message + '</p>';
            }
        }

        // Criar card de foto
        function createPhotoCard(id, data) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <img src="${data.url}" alt="Foto da igreja" class="item-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%23999%22 x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22%3EErro%3C/text%3E%3C/svg%3E'">
                <p><strong>Descri√ß√£o:</strong> ${data.description || 'Sem descri√ß√£o'}</p>
                <p><strong>Data:</strong> ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</p>
                <div class="item-actions">
                    <button class="btn btn-danger" onclick="deletePhoto('${id}', '${data.fileName || ''}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        // Excluir foto
        async function deletePhoto(docId, fileName) {
            if (!confirm('Tem certeza que deseja excluir esta foto?')) return;

            console.log('üóëÔ∏è Excluindo foto:', docId);

            try {
                // Deletar do Storage
                if (fileName) {
                    try {
                        await storage.ref().child(fileName).delete();
                        console.log('‚úÖ Deletada do Storage');
                    } catch (storageError) {
                        console.warn('‚ö†Ô∏è Erro ao deletar do Storage:', storageError);
                    }
                }

                // Deletar do Firestore
                await db.collection('photos').doc(docId).delete();
                console.log('‚úÖ Deletada do Firestore');

                showMessage('‚úÖ Foto exclu√≠da com sucesso!', 'success');
                loadPhotos();

            } catch (error) {
                console.error('‚ùå Erro ao excluir foto:', error);
                showMessage('‚ùå Erro ao excluir foto: ' + error.message, 'error');
            }
        }

        // Fun√ß√µes de eventos
        document.getElementById('event-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            console.log('üìÖ Adicionando evento...');

            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const description = document.getElementById('event-description').value;
            const location = document.getElementById('event-location').value;

            console.log('Evento:', { title, date, time, description, location });

            const loading = document.getElementById('event-loading');
            loading.style.display = 'block';

            try {
                await db.collection('events').add({
                    title: title,
                    date: date,
                    time: time,
                    description: description,
                    location: location,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('‚úÖ Evento adicionado com sucesso');
                showMessage('‚úÖ Evento adicionado com sucesso!', 'success');
                document.getElementById('event-form').reset();
                // Restaurar valor padr√£o do local
                document.getElementById('event-location').value = 'Tv. Natividade, 07 - Novo Horizonte, Nil√≥polis - RJ';
                loadEvents();

            } catch (error) {
                console.error('‚ùå Erro ao adicionar evento:', error);
                showMessage('‚ùå Erro ao adicionar evento: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        });

        // Carregar eventos
        async function loadEvents() {
            console.log('üìÖ Carregando eventos...');
            const grid = document.getElementById('events-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando eventos...</p></div>';

            try {
                const snapshot = await db.collection('events').orderBy('date', 'asc').get();
                grid.innerHTML = '';

                console.log(`‚úÖ ${snapshot.docs.length} evento(s) encontrado(s)`);

                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">Nenhum evento encontrado. Adicione eventos acima.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const eventCard = createEventCard(doc.id, data);
                    grid.appendChild(eventCard);
                });

            } catch (error) {
                console.error('‚ùå Erro ao carregar eventos:', error);
                grid.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Erro ao carregar eventos: ' + error.message + '</p>';
            }
        }

        // Criar card de evento
        function createEventCard(id, data) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            let eventDate;
            try {
                eventDate = new Date(data.date + 'T' + data.time);
            } catch (e) {
                eventDate = new Date();
            }
            
            const isUpcoming = eventDate > new Date();

            card.innerHTML = `
                <div style="border-left: 4px solid ${isUpcoming ? '#00b894' : '#ddd'}; padding-left: 15px;">
                    <h4 style="color: ${isUpcoming ? '#00b894' : '#666'};">${data.title}</h4>
                    <p><i class="fas fa-calendar"></i> ${new Date(data.date).toLocaleDateString('pt-BR')}</p>
                    <p><i class="fas fa-clock"></i> ${data.time}</p>
                    ${data.location ? `<p><i class="fas fa-map-marker-alt"></i> ${data.location}</p>` : ''}
                    ${data.description ? `<p><i class="fas fa-info-circle"></i> ${data.description}</p>` : ''}
                    <small style="color: #999;">Status: ${isUpcoming ? 'üü¢ Pr√≥ximo' : 'üî¥ Passado'}</small>
                </div>
                <div class="item-actions">
                    <button class="btn btn-danger" onclick="deleteEvent('${id}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            `;
            return card;
        }

        // Excluir evento
        async function deleteEvent(docId) {
            if (!confirm('Tem certeza que deseja excluir este evento?')) return;

            console.log('üóëÔ∏è Excluindo evento:', docId);

            try {
                await db.collection('events').doc(docId).delete();
                console.log('‚úÖ Evento exclu√≠do');
                showMessage('‚úÖ Evento exclu√≠do com sucesso!', 'success');
                loadEvents();

            } catch (error) {
                console.error('‚ùå Erro ao excluir evento:', error);
                showMessage('‚ùå Erro ao excluir evento: ' + error.message, 'error');
            }
        }

        // Mostrar mensagens
        function showMessage(message, type) {
            console.log('üí¨ Mensagem:', message);
            
            // Remove mensagens existentes
            document.querySelectorAll('.success-message, .error-message').forEach(el => el.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = type + '-message';
            messageDiv.textContent = message;
            messageDiv.style.padding = '15px';
            messageDiv.style.borderRadius = '10px';
            messageDiv.style.margin = '15px 0';
            messageDiv.style.fontWeight = '500';

            if (type === 'success') {
                messageDiv.style.background = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.border = '1px solid #c3e6cb';
            } else {
                messageDiv.style.background = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.border = '1px solid #f5c6cb';
            }

            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Preview de arquivos selecionados
        document.getElementById('photo-files').addEventListener('change', function (e) {
            const files = e.target.files;
            const label = document.querySelector('.file-upload-label');

            if (files.length > 0) {
                const totalSize = Array.from(files).reduce((sum, file) => sum + file.size, 0);
                const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
                
                label.innerHTML = `<i class="fas fa-check-circle" style="color: #00b894; font-size: 2rem; margin-right: 10px;"></i>${files.length} foto(s) selecionada(s) (${sizeMB} MB)`;
                console.log(`üìÅ ${files.length} arquivo(s) selecionado(s) - ${sizeMB} MB`);
            } else {
                label.innerHTML = '<i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-right: 10px;"></i>Clique para selecionar fotos';
            }
        });

        // Teste de conectividade ao carregar
        window.addEventListener('load', async function() {
            console.log('üîå Testando conectividade com Firebase...');
            
            try {
                // Testar Firestore
                await db.collection('test').limit(1).get();
                console.log('‚úÖ Firestore: Conectado');
                
                // Testar Storage
                const storageRef = storage.ref();
                await storageRef.listAll();
                console.log('‚úÖ Storage: Conectado');
                
            } catch (error) {
                console.error('‚ùå Erro de conectividade:', error);
                alert('‚ö†Ô∏è Problemas de conectividade com Firebase. Verifique:\n\n' +
                      '1. Suas regras de seguran√ßa do Firestore\n' +
                      '2. Suas regras de seguran√ßa do Storage\n' +
                      '3. Sua conex√£o com a internet\n\n' +
                      'Erro: ' + error.message);
            }
        });

        console.log('‚úÖ Painel administrativo carregado completamente');
        console.log('üìã Para testar:');
        console.log('1. Senha: ibfav2025admin');
        console.log('2. Abra F12 ‚Üí Console para ver logs detalhados');
    </script>
</body>

</html>